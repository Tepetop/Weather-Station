# Copilot Instructions for STM32 Weather Station Indoor Unit

## Project Overview
STM32F103C8T6 microcontroller project for a Weather Station Indoor Unit.
**Core Responsibilities:**
- Request and receive measurements from external units via nRF24L01+.
- Maintain real-time clock and schedule measurements via DS3231.
- Display data on PCD8544 (Nokia 5110) LCD.
- Log data to SD Card (CSV/JSON).
- Handle user input via Rotary Encoder and Button.
- Manage power states (Active/Screensaver).

## Hardware & Peripheral Configuration

### Core Hardware
- **MCU**: STM32F103C8T6 (ARM Cortex-M3).
- **Display**: Nokia 5110 (PCD8544 controller) via SPI.
- **Wireless**: nRF24L01+ (2.4GHz Transceiver) via SPI.
- **RTC**: DS3231 via I2C.
- **Storage**: SD Card via SPI/SDIO (FATFS).
- **Input**: Rotary Encoder (Time/Direction) + Push Button (External Interrupts).

### Configuration Files (HAL)
- **Pin Definitions**: Located in `Core/Inc/main.h` and specific peripheral files.
- **Peripheral Init**:
  - SPI (LCD, nRF, SD): Configured in `Core/Src/spi.c` and `Core/Inc/spi.h`.
  - I2C (RTC): Configured in `Core/Src/i2c.c` and `Core/Inc/i2c.h`.
  - GPIO (Controls): Configured in `Core/Src/gpio.c` and `Core/Inc/gpio.h`.
- **Constraint**: **Always** place code between `/* USER CODE BEGIN ... */` and `/* USER CODE END ... */`.

## Functional Requirements

### 1. Measurement System
- **Trigger**: Every 1 minute, triggered by DS3231 RTC interrupt or alarm polling.
- **Manual Trigger**: User can select "TAKE MEASUREMENT" from the menu.
- **Action**:
  1. Wake nRF24L01+.
  2. Send request packet to Outdoor Unit.
  3. Wait for response (with timeout).
  4. Timestamp data with RTC time.
  5. Log to SD Card.
  6. Update Display (if active).

### 2. User Interface (UI)
- **Input**: Rotary Encoder for navigation (Up/Down), Button for Enter/Wake.
- **Menu Structure**:
  - **MEASUREMENTS**: Live view of current data.
  - **HISTORY**: View past records (from SD/Memory).
  - **TAKE MEASUREMENT**: Force immediate measurement.
  - **SETTINGS**: Time set, etc.
- **Screensaver**:
  - Display turns off (or enters low power mode) after inactivity.
  - Wakes up on Button press.
- **Implementation**:
  - Menu state machine in `Core/Src/PCD_LCD/PCD8544_Menu.c`.
  - Button handling via External Interrupts (EXTI) in `stm32f1xx_it.c` or polling in `main.c`.

### 3. Data Logging
- **Format**: CSV or JSON (TBD).
- **Storage**: Append to daily log file on SD Card.
- **Library**: Use FatFS middleware (configured via CubeMX).

## Development Guidelines

### Code Integration
- **Generated Files**: `main.c`, `spi.c`, `dma.c`, `gpio.c`, etc. are generated by STM32CubeMX.
- **Initialization**: Ensure per-module initialization (LCD, NRF, RTC, SD) is called in `main()` after `HAL_Init()`.
- **Interrupts**: Handle GPIO (Encoder/Button) and RTC interrupts in `stm32f1xx_it.c`, forwarding calls to logic handlers.

### Critical Libraries
- **PCD8544**: Located in `Core/Src/PCD_LCD/`.
- **FatFS**: Standard STM32 middleware.
- **nRF24L01+**: Requires HAL-based driver (to be added to `Core/Src/`).
- **DS3231**: Requires I2C HAL-based driver (to be added to `Core/Src/`).

### Project Structure (CMake)
- **Build**: Use `cmake --preset Debug` and `cmake --build build/Debug`.
- **Flash/Debug**: ST-Link using OpenOCD or pyOCD.

### Performance
- **Low Power**: Use `HAL_SuspendTick()` and `HAL_PWR_EnterSLEEPMode()` when idle if possible.
- **SPI Bus Sharing**: Be mindful of Chip Select (CS/CE) management if multiple devices share the same SPI bus.

## Workflow Status
- **Current Focus**: Implementing basic drivers and menu structure.
- **Next Steps**: Integrate nRF24L01+ communication and SD Card logging.
